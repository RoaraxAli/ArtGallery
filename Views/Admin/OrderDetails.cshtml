@model Project.Models.Order
@{
    ViewData["Title"] = "Order Details";
}

<!-- Print Only Invoice Layout -->
<div id="print-invoice" class="hidden print:block p-8 bg-white text-black font-sans">
    
    <!-- Invoice Header -->
    <div class="flex justify-between items-start border-b-2 border-black pb-8 mb-8">
        <div>
            <h1 class="text-4xl font-black tracking-tighter mb-2 flex items-center gap-3">
                <i class="bi bi-layers-half"></i> GALLERY
            </h1>
            <p class="text-sm text-gray-600">Administrative Invoice</p>
        </div>
        <div class="text-right">
            <h2 class="text-xl font-bold uppercase tracking-widest mb-1">Invoice</h2>
            <p class="text-sm">Order #@Model.Id</p>
            <p class="text-sm">Date: @Model.OrderDate.ToString("MMMM dd, yyyy")</p>
        </div>
    </div>

    <!-- Bill To / Ship To -->
    <div class="grid grid-cols-2 gap-12 mb-12">
        <div>
            <h3 class="text-xs font-bold uppercase tracking-widest border-b border-gray-300 pb-2 mb-4">Bill To</h3>
            <p class="font-bold text-lg">@Model.CustomerName</p>
            <p class="text-sm text-gray-600">@Model.User.Email</p>
        </div>
        <div>
            <h3 class="text-xs font-bold uppercase tracking-widest border-b border-gray-300 pb-2 mb-4">Ship To</h3>
            <p class="font-bold text-lg">@Model.CustomerName</p>
            <p class="text-sm text-gray-600 w-2/3">@Model.ShippingAddress</p>
        </div>
    </div>

    <!-- Items Table -->
    <table class="w-full mb-12">
        <thead>
            <tr class="border-b-2 border-black">
                <th class="text-left py-3 text-sm font-bold uppercase">Description</th>
                <th class="text-center py-3 text-sm font-bold uppercase">Qty</th>
                <th class="text-right py-3 text-sm font-bold uppercase">Price</th>
                <th class="text-right py-3 text-sm font-bold uppercase">Total</th>
            </tr>
        </thead>
        <tbody class="text-sm">
            @foreach (var item in Model.OrderItems)
            {
                <tr class="border-b border-gray-200">
                    <td class="py-4">
                        <p class="font-bold">@item.ProductName</p>
                        <p class="text-xs text-gray-500">Art Gallery Collection</p>
                    </td>
                    <td class="text-center py-4">@item.Quantity</td>
                    <td class="text-right py-4">$@item.Price.ToString("N0")</td>
                    <td class="text-right py-4 font-bold">$@((item.Price * item.Quantity).ToString("N0"))</td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Totals -->
    <div class="flex justify-end mb-12">
        <div class="w-1/3 space-y-3">
            <div class="flex justify-between text-sm">
                <span class="font-medium text-gray-600">Subtotal</span>
                <span>$@Model.TotalAmount.ToString("N0")</span>
            </div>
            <div class="flex justify-between text-sm border-b border-gray-300 pb-3">
                <span class="font-medium text-gray-600">Tax (0%)</span>
                <span>$0.00</span>
            </div>
            <div class="flex justify-between text-xl font-black">
                <span>Total</span>
                <span>$@Model.TotalAmount.ToString("N0")</span>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="text-center pt-8 border-t border-gray-200 text-xs text-gray-500">
        <p>Thank you for your business.</p>
        <p class="mt-1">For questions concerning this invoice, please contact support.</p>
    </div>
</div>

<style>
    @@media print {
        /* 1. Hide everything visually, but keep the DOM structure "rendered" so children can be shown */
        body * {
            visibility: hidden;
        }
        
        /* 2. Target our specific print container and its children to be visible */
        #print-invoice, #print-invoice * {
            visibility: visible;
        }

        /* 3. Position the invoice to cover the entire page overlaying the hidden content */
        #print-invoice {
            position: absolute; /* Absolute works better than fixed for multi-page content flow */
            left: 0;
            top: 0;
            width: 100%;
            margin: 0;
            padding: 20px;
            background-color: white !important;
            color: black !important;
            z-index: 99999;
        }
        
        /* 4. Ensure texts are strictly black */
        #print-invoice p, #print-invoice h1, #print-invoice h2, #print-invoice h3, #print-invoice span, #print-invoice td, #print-invoice th {
            color: black !important;
            text-shadow: none !important;
        }
        
        /* 5. Reset page styling */
        @@page { 
            margin: 1cm; 
            size: auto; 
        }
    }
</style>

<!-- Main Dashboard UI (Hidden on Print) -->
<div class="mb-8 animate-fade-in print:hidden">
    <a asp-action="Orders" class="inline-flex items-center gap-2 text-sm font-bold text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors mb-6 group">
        <i class="bi bi-arrow-left group-hover:-translate-x-1 transition-transform"></i> Back to Orders
    </a>
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <div class="flex items-center gap-4 mb-2">
                <h1 class="text-3xl font-bold text-white">Order #@Model.Id</h1>
                @{
                    var statusColor = "bg-gray-500/10 text-gray-400 border-gray-500/20";
                    if (Model.Status == "Pending") statusColor = "bg-amber-500/10 text-amber-500 border-amber-500/20";
                    if (Model.Status == "Confirmed") statusColor = "bg-blue-500/10 text-blue-400 border-blue-500/20";
                    if (Model.Status == "Shipped") statusColor = "bg-purple-500/10 text-purple-400 border-purple-500/20";
                    if (Model.Status == "Delivered") statusColor = "bg-green-500/10 text-green-400 border-green-500/20";
                    if (Model.Status == "Cancelled") statusColor = "bg-red-500/10 text-red-400 border-red-500/20";
                }
                <span class="px-3 py-1 rounded-full border text-[10px] font-black uppercase tracking-widest @statusColor">
                    @Model.Status
                </span>
            </div>
            <p class="text-[var(--text-secondary)]">Placed on <span class="text-white">@Model.OrderDate.ToString("MMMM dd, yyyy")</span> at @Model.OrderDate.ToString("HH:mm")</p>
        </div>
        
        <div class="flex gap-3">
             <button onclick="window.print()" class="px-4 py-2 rounded-xl bg-[var(--bg-surface-2)] hover:bg-[var(--glass-border)] text-white text-sm font-bold transition-colors">
                <i class="bi bi-printer mr-2"></i> Print Invoice
            </button>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8" id="printable-area">
    
    <!-- Main Content: Items -->
    <div class="lg:col-span-2 space-y-6 animate-slide-down">
        <div class="glass rounded-3xl border border-[var(--glass-border)] overflow-hidden">
            <div class="p-6 border-b border-[var(--glass-border)]">
                <h3 class="font-bold text-lg text-white">Order Items</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-[var(--bg-surface-2)] text-xs text-[var(--text-secondary)] uppercase">
                        <tr>
                            <th class="px-6 py-4">Item Details</th>
                            <th class="px-6 py-4 text-center">Qty</th>
                            <th class="px-6 py-4 text-right">Price</th>
                            <th class="px-6 py-4 text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-[var(--glass-border)]">
                        @foreach (var item in Model.OrderItems)
                        {
                            <tr>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-4">
                                        <div class="w-16 h-16 rounded-lg bg-[var(--bg-surface-2)] overflow-hidden border border-[var(--glass-border)] flex-shrink-0">
                                            @if(!string.IsNullOrEmpty(item.ImageUrl)) {
                                                <img src="@item.ImageUrl" class="w-full h-full object-cover" />
                                            } else {
                                                <div class="w-full h-full flex items-center justify-center text-[var(--text-secondary)]">
                                                    <i class="bi bi-image"></i>
                                                </div>
                                            }
                                        </div>
                                        <div>
                                            <p class="font-bold text-white mb-1">@item.ProductName</p>
                                            <p class="text-xs text-[var(--text-secondary)]">Art Gallery Collection</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-center font-bold text-[var(--text-secondary)]">x@(item.Quantity)</td>
                                <td class="px-6 py-4 text-right text-[var(--text-secondary)]">$@item.Price.ToString("N0")</td>
                                <td class="px-6 py-4 text-right font-bold text-white">$@((item.Price * item.Quantity).ToString("N0"))</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="bg-[var(--bg-surface-2)]">
                        <tr>
                            <td colspan="3" class="px-6 py-4 text-right text-sm font-bold text-[var(--text-secondary)] uppercase tracking-wider">Total Amount</td>
                            <td class="px-6 py-4 text-right text-xl font-black text-[var(--primary-color)]">$@Model.TotalAmount.ToString("N0")</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Timeline -->
        <div class="glass rounded-3xl border border-[var(--glass-border)] p-6 no-print">
            <h3 class="font-bold text-lg text-white mb-6">Order Timeline</h3>
            <div class="relative pl-4 border-l-2 border-[var(--glass-border)] space-y-8">
                
                @{
                    bool isPending = Model.Status == "Pending";
                    bool isConfirmed = Model.Status == "Confirmed";
                    bool isShipped = Model.Status == "Shipped";
                    bool isDelivered = Model.Status == "Delivered";
                    bool isCancelled = Model.Status == "Cancelled";
                }

                <!-- Placed -->
                <div class="relative group">
                    <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-green-500 border-4 border-[var(--bg-primary)] @(isPending ? "scale-150 shadow-[0_0_15px_rgba(34,197,94,0.5)]" : "") transition-all"></div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-[var(--text-secondary)] font-mono mb-0.5">@Model.OrderDate.ToString("MMM dd, yyyy HH:mm")</span>
                        <p class="text-sm font-bold text-white @(isPending ? "text-green-400" : "")">Order Placed</p>
                        <p class="text-xs text-[var(--text-secondary)]">Order #@Model.Id was created by customer.</p>
                    </div>
                </div>
                
                @if (!isCancelled) 
                {
                    <div class="relative group @(Model.Status == "Pending" ? "opacity-30" : "")">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-blue-500 border-4 border-[var(--bg-primary)] @(isConfirmed ? "scale-150 shadow-[0_0_15px_rgba(59,130,246,0.5)]" : "") transition-all"></div>
                        <div class="flex flex-col">
                            <p class="text-sm font-bold text-white @(isConfirmed ? "text-blue-400" : "")">Confirmed</p>
                            <p class="text-xs text-[var(--text-secondary)]">Payment verified and order confirmed.</p>
                        </div>
                    </div>

                    <div class="relative group @((Model.Status == "Pending" || Model.Status == "Confirmed") ? "opacity-30" : "")">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-purple-500 border-4 border-[var(--bg-primary)] @(isShipped ? "scale-150 shadow-[0_0_15px_rgba(168,85,247,0.5)]" : "") transition-all"></div>
                        <div class="flex flex-col">
                            <p class="text-sm font-bold text-white @(isShipped ? "text-purple-400" : "")">Shipped</p>
                            <p class="text-xs text-[var(--text-secondary)]">Package is on its way to the destination.</p>
                        </div>
                    </div>

                    <div class="relative group @(Model.Status != "Delivered" ? "opacity-30" : "")">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-green-500 border-4 border-[var(--bg-primary)] @(isDelivered ? "scale-150 shadow-[0_0_15px_rgba(34,197,94,0.5)]" : "") transition-all"></div>
                        <div class="flex flex-col">
                             <p class="text-sm font-bold text-white @(isDelivered ? "text-green-400" : "")">Delivered</p>
                            <p class="text-xs text-[var(--text-secondary)]">Package successfully delivered to customer.</p>
                        </div>
                    </div>
                }
                else 
                {
                     <div class="relative group">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-red-500 border-4 border-[var(--bg-primary)] scale-150 shadow-[0_0_15px_rgba(239,68,68,0.5)]"></div>
                        <div class="flex flex-col">
                            <p class="text-sm font-bold text-red-400">Cancelled</p>
                            <p class="text-xs text-[var(--text-secondary)]">This order has been cancelled.</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Sidebar: Customer & Actions -->
    <div class="space-y-6 animate-slide-down no-print" style="animation-delay: 100ms;">
        
        <!-- Customer Info -->
        <div class="glass rounded-3xl border border-[var(--glass-border)] p-6">
            <h3 class="font-bold text-lg text-white mb-6">Customer Details</h3>
            
            <div class="flex items-center gap-4 mb-6 pb-6 border-b border-[var(--glass-border)]">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 overflow-hidden flex items-center justify-center text-white font-bold text-lg shadow-lg">
                    @if (!string.IsNullOrEmpty(Model.User.Avatar))
                    {
                        <img src="@Model.User.Avatar" class="w-full h-full object-cover" />
                    }
                    else
                    {
                        @((Model.CustomerName ?? "U")[0])
                    }
                </div>
                <div>
                     <p class="font-bold text-white">@Model.CustomerName</p>
                     <p class="text-xs text-[var(--text-secondary)]">Verified Customer</p>
                </div>
            </div>

            <div class="space-y-4">
                 <div>
                    <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest block mb-1">Email Address</label>
                    <div class="flex items-center gap-2 text-sm text-white">
                        <i class="bi bi-envelope"></i> @Model.User.Email
                    </div>
                 </div>
                 
                 <div>
                    <label class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest block mb-1">Shipping Address</label>
                    <div class="flex items-start gap-2 text-sm text-white">
                        <i class="bi bi-geo-alt mt-1"></i> 
                        <span class="break-words w-full">@Model.ShippingAddress</span>
                    </div>
                 </div>
            </div>
        </div>

        <!-- Management Actions -->
        <div class="glass rounded-3xl border border-[var(--glass-border)] p-6">
            <h3 class="font-bold text-lg text-white mb-6">Order Actions</h3>
            
            <form asp-action="UpdateOrderStatus" method="post" class="space-y-4">
                <input type="hidden" name="id" value="@Model.Id" />
                
                <div class="space-y-2">
                    <label class="text-xs text-[var(--text-secondary)] font-bold uppercase">Update Status</label>
                    <div class="relative">
                        <select name="status" class="w-full appearance-none bg-[var(--bg-surface-2)] border border-[var(--glass-border)] rounded-xl px-4 py-3 text-white outline-none focus:border-[var(--primary-color)] transition-colors cursor-pointer">
                            <option value="Pending" selected="@(Model.Status == "Pending")">Pending Process</option>
                            <option value="Confirmed" selected="@(Model.Status == "Confirmed")">Confirmed</option>
                            <option value="Shipped" selected="@(Model.Status == "Shipped")">Shipped</option>
                            <option value="Delivered" selected="@(Model.Status == "Delivered")">Delivered</option>
                            <option value="Cancelled" selected="@(Model.Status == "Cancelled")">Cancelled</option>
                        </select>
                        <i class="bi bi-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] pointer-events-none"></i>
                    </div>
                </div>

                <div id="delivery-date-container" class="@(Model.Status == "Shipped" ? "" : "hidden") space-y-2">
                    <label class="text-xs text-[var(--text-secondary)] font-bold uppercase">Estimated Delivery</label>
                    <input type="date" name="deliveryDate" class="w-full bg-[var(--bg-surface-2)] border border-[var(--glass-border)] rounded-xl px-4 py-3 text-white outline-none focus:border-[var(--primary-color)]" />
                </div>

                <button type="submit" class="w-full py-3 rounded-xl bg-[var(--primary-color)] hover:bg-[var(--primary-color)]/90 text-white font-bold shadow-lg shadow-[var(--primary-color)]/25 transition-all transform hover:scale-[1.02]">
                    Update Order Status
                </button>
            </form>
            
            @if (!Model.IsPaid)
            {
                <div class="mt-6 pt-6 border-t border-[var(--glass-border)]">
                    <div class="bg-amber-500/10 border border-amber-500/20 p-4 rounded-xl mb-4">
                        <div class="flex items-center gap-2 text-amber-500 mb-1">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <span class="text-xs font-bold uppercase">Payment Pending</span>
                        </div>
                        <p class="text-[11px] text-[var(--text-secondary)] leading-relaxed">Customer has not yet completed payment for this order.</p>
                    </div>
                    
                    <form asp-action="SendPaymentReminder" method="post">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <button type="submit" class="w-full py-3 rounded-xl border border-amber-500 text-amber-500 hover:bg-amber-500 hover:text-black font-bold transition-all">
                            Send Payment Reminder
                        </button>
                    </form>
                </div>
            }
        </div>

    </div>
</div>

@section Scripts {
    <script>
        const statusSelect = document.querySelector('select[name="status"]');
        const dateContainer = document.getElementById('delivery-date-container');
        
        if(statusSelect && dateContainer) {
            statusSelect.addEventListener('change', function() {
                if (this.value === 'Shipped') {
                    dateContainer.classList.remove('hidden');
                } else {
                    dateContainer.classList.add('hidden');
                }
            });
        }
    </script>
}
